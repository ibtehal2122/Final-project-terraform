- name: Create monitoring namespace
  kubernetes.core.k8s:
    name: monitoring
    api_version: v1
    kind: Namespace
    state: present

- name: Add Prometheus Community Helm repository
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: "https://prometheus-community.github.io/helm-charts"
    state: present

- name: Create Grafana admin password secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: grafana-admin-credentials
        namespace: monitoring
      stringData:
        admin-user: admin
        admin-password: "{{ grafana_admin_password }}"

- name: Deploy kube-prometheus-stack
  kubernetes.core.helm:
    name: kube-prometheus-stack
    chart_ref: prometheus-community/kube-prometheus-stack
    release_namespace: monitoring
    create_namespace: false
    chart_version: "{{ monitoring_chart_version }}"
    values: "{{ monitoring_helm_values | from_yaml }}"

- name: Create Ingress for Grafana
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'roles/monitoring/templates/ingress.yaml.j2') }}"
