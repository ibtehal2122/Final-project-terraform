name: "Production Deployment Pipeline"

on:
  push:
    branches:
      - main  # 1. يشتغل فقط عند عمل Push لفرع الـ main

env:
  AWS_REGION: "us-east-1"
  CLUSTER_NAME: "ebtehal-final-eks" # 2. نفس الاسم الموجود في Terraform

permissions:
  contents: read # 3. تصريح قراءة الكود فقط (Security Best Practice)

jobs:
  # ---------------------------------------------------
  # Job 1: Terraform (بناء البنية التحتية)
  # ---------------------------------------------------
  terraform:
    name: "Provision Infrastructure (Terraform)"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform # 4. الدخول لمجلد التيررافورم

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 # 5. سحب الكود من GitHub

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4 # 6. تسجيل الدخول لـ AWS
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3 # 7. تنزيل وتسطيب Terraform

      - name: Terraform Init
        run: terraform init # 8. تهيئة المشروع وتحميل الـ Providers

      - name: Terraform Validate
        run: terraform validate # 9. التأكد من صحة الكود

      - name: Terraform Apply
        # 10. التنفيذ الفعلي وبناء الـ Resources
        run: terraform apply -auto-approve

  # ---------------------------------------------------
  # Job 2: Ansible (تجهيز الكلستر بالتطبيقات)
  # ---------------------------------------------------
  ansible:
    name: "Configure Cluster (Ansible)"
    needs: terraform  # 11. لا تبدأ إلا بعد نجاح التيررافورم
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ansible # 12. الدخول لمجلد الأنسبل

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 13. تسطيب الأدوات اللازمة للـ Ansible للتعامل مع EKS
      - name: Install Tools (Ansible, Helm, Kubectl)
        run: |
          sudo apt-get update
          # نزلنا الأدوات الأساسية بس (شلنا helm من هنا)
          sudo apt-get install -y ansible python3-pip apt-transport-https gnupg curl
          
          # --- التعديل الجديد: تنزيل Helm من السكريبت الرسمي ---
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh
          # -----------------------------------------------------

          # Install Python Libs
          pip3 install kubernetes helm --break-system-packages
          
          # Install Ansible Collection
          ansible-galaxy collection install kubernetes.core

      - name: Run Ansible Playbook
        # 14. تشغيل الـ Playbook مع تمرير المتغيرات
        run: |
          ansible-playbook playbook.yaml \
          --extra-vars "aws_region=${{ env.AWS_REGION }} eks_cluster_name=${{ env.CLUSTER_NAME }}"
