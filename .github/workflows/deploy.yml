name: "Production Deployment Pipeline"

on:
  workflow_dispatch:

env:
  AWS_REGION: "us-east-1"
  CLUSTER_NAME: "ebtehal-final-eks"

permissions:
  id-token: write # Required for OIDC
  contents: read

jobs:
  # ---------------------------------------------------
  # Job 1: Terraform (Infrastructure)
  # ---------------------------------------------------
  terraform:
    name: "Provision Infrastructure (Terraform)"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name of "Configure AWS Credentials"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role # Replace with your IAM role ARN
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -out=tfplan
      
      - name: Manual Approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: "ebtehal-9" # Replace with your GitHub username
          minimum-approvals: 1
          issue-title: "Deployment Plan for ${{ github.sha }}"
          issue-body: |
            Please review the Terraform plan below and approve or deny the deployment.
            ```
            ${{ steps.plan.outputs.stdout }}
            ```
          
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

  # ---------------------------------------------------
  # Job 2: Update GitOps Repository
  # ---------------------------------------------------
  update-gitops-repo:
    name: "Update GitOps Repository"
    needs: terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GitOps Repository
        uses: actions/checkout@v4
        with:
          repository: "ebtehal-9/gitops-repo" # Replace with your GitOps repository
          token: ${{ secrets.GITOPS_REPO_TOKEN }} # A PAT with repo write access

      - name: Update Application Version
        run: |
          # This is a placeholder for your logic to update the application version
          # For example, you might update a Kustomize overlay or a Helm values file
          sed -i "s/tag: .*/tag: ${{ github.sha }}/" my-app/deployment.yaml
          
      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@github.com"
          git add .
          git commit -m "Update application to version ${{ github.sha }}"
          git push