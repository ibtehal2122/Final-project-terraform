name: "üß® Emergency Force Cleanup"

on:
  workflow_dispatch:

env:
  AWS_REGION: "us-east-1"
  # This is the VPC ID from your error log
  VPC_ID: "vpc-07a7ff701c7a11f12" 
  TF_BACKEND_BUCKET: ${{ secrets.BUCKET }}

jobs:
  nuke-dependencies:
    name: "Force Delete VPC Dependencies"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ---------------------------------------------------------
      # STEP 1: Delete Load Balancers (The usual suspects)
      # ---------------------------------------------------------
      - name: üßπ Delete Load Balancers
        run: |
          echo "üîç Finding Load Balancers in VPC: ${{ env.VPC_ID }}"
          
          # 1. Classic ELBs
          CLBS=$(aws elb describe-load-balancers --query "LoadBalancerDescriptions[?VPCId=='${{ env.VPC_ID }}'].LoadBalancerName" --output text)
          for lb in $CLBS; do
            echo "üî• Deleting Classic LB: $lb"
            aws elb delete-load-balancer --load-balancer-name $lb
          done

          # 2. Network/Application LBs (ALB/NLB)
          VLBS=$(aws elbv2 describe-load-balancers --query "LoadBalancers[?VpcId=='${{ env.VPC_ID }}'].LoadBalancerArn" --output text)
          for lb in $VLBS; do
            echo "üî• Deleting V2 LB: $lb"
            # Enable deletion protection just in case, then delete
            aws elbv2 modify-load-balancer-attributes --load-balancer-arn $lb --attributes Key=deletion_protection.enabled,Value=false
            aws elbv2 delete-load-balancer --load-balancer-arn $lb
            echo "   (Deleted)"
          done
          
          echo "‚è≥ Waiting 30s for LBs to drain..."
          sleep 30

      # ---------------------------------------------------------
      # STEP 2: Delete "Ghost" Network Interfaces (ENIs)
      # This is usually what blocks the VPC delete
      # ---------------------------------------------------------
      - name: üßπ Delete Stuck Network Interfaces
        run: |
          echo "üîç Finding Network Interfaces in VPC: ${{ env.VPC_ID }}"
          
          # Get all ENIs in the VPC
          ENIS=$(aws ec2 describe-network-interfaces --filters Name=vpc-id,Values=${{ env.VPC_ID }} --query "NetworkInterfaces[*].NetworkInterfaceId" --output text)
          
          for eni in $ENIS; do
            echo "üî• Attempting to delete ENI: $eni"
            # Try to detach first (forcefully)
            aws ec2 delete-network-interface --network-interface-id $eni || true
          done

      # ---------------------------------------------------------
      # STEP 3: Delete Security Groups (except 'default')
      # ---------------------------------------------------------
      - name: üßπ Delete Security Groups
        run: |
          SGS=$(aws ec2 describe-security-groups --filters Name=vpc-id,Values=${{ env.VPC_ID }} --query "SecurityGroups[?GroupName!='default'].GroupId" --output text)
          
          for sg in $SGS; do
            echo "üî• Deleting SG: $sg"
            aws ec2 delete-security-group --group-id $sg || echo "   (Could not delete yet, might be attached to something else)"
          done

      # ---------------------------------------------------------
      # STEP 4: Terraform Destroy (Clean Finish)
      # ---------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend-config="bucket=${{ env.TF_BACKEND_BUCKET }}"

      - name: Terraform Destroy
        run: |
          cd terraform
          terraform refresh
          terraform destroy -auto-approve