name: "ğŸ’€ Destroy Infrastructure (Force Clean)"

on:
  workflow_dispatch:

env:
  AWS_REGION: "us-east-1"
  TF_WORKING_DIR: "./terraform"
  EKS_CLUSTER_NAME: "ebtehal-final-eks"
  ECR_REPO_NAME: "ebtehal-final-eks-repo"

jobs:
  force-destroy:
    name: "Clean & Destroy"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ---------------------------------------------------------
      # ğŸ§¹ Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ Load Balancers "ØºØµØ¨"
      # (Ø£Ù‡Ù… Ø®Ø·ÙˆØ© Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù€ VPC Dependency)
      # ---------------------------------------------------------
      - name: ğŸ§¹ Force Cleanup Load Balancers
        run: |
          echo "ğŸ” Searching for Load Balancers created by Kubernetes..."
          
          # Ù‡Ø§Øª Ø§Ù„Ù€ VPC ID Ù…Ù† Ø§Ù„Ù€ Cluster (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯)
          VPC_ID=$(aws eks describe-cluster --name ${{ env.EKS_CLUSTER_NAME }} --query "cluster.resourcesVpcConfig.vpcId" --output text || echo "None")
          
          if [ "$VPC_ID" != "None" ] && [ "$VPC_ID" != "" ]; then
            echo "ğŸ¯ Cluster VPC ID: $VPC_ID"
            
            # Ù‡Ø§Øª ÙƒÙ„ Ø§Ù„Ù€ LBs Ø§Ù„Ù„ÙŠ ÙÙŠ Ø§Ù„Ù€ VPC Ø¯Ù‡
            LBS=$(aws elb describe-load-balancers --query "LoadBalancerDescriptions[?VPCId=='$VPC_ID'].LoadBalancerName" --output text)
            
            for lb in $LBS; do
              echo "ğŸ”¥ Deleting Classic Load Balancer: $lb"
              aws elb delete-load-balancer --load-balancer-name $lb
            done
            
            # Ù„Ùˆ ÙÙŠÙ‡ Network Load Balancers (v2)
            LBS_V2=$(aws elbv2 describe-load-balancers --query "LoadBalancers[?VpcId=='$VPC_ID'].LoadBalancerArn" --output text)
            
            for lb_arn in $LBS_V2; do
              echo "ğŸ”¥ Deleting Network Load Balancer: $lb_arn"
              aws elbv2 delete-load-balancer --load-balancer-arn $lb_arn
            done
            
            echo "â³ Waiting 30s for AWS to release IPs..."
            sleep 30
          else
            echo "âš ï¸ Cluster not found or VPC ID unavailable. Skipping LB cleanup."
          fi

      # ---------------------------------------------------------
      # ğŸ—‘ï¸ Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªÙØ±ÙŠØº Ø§Ù„Ù€ ECR (Ø¹Ø´Ø§Ù† ÙŠØ±Ø¶Ù‰ ÙŠØªÙ…Ø³Ø­)
      # ---------------------------------------------------------
      - name: ğŸ—‘ï¸ Empty ECR Repository
        run: |
          echo "Emptying ECR: ${{ env.ECR_REPO_NAME }}"
          IMAGES=$(aws ecr list-images --repository-name ${{ env.ECR_REPO_NAME }} --query 'imageIds[*]' --output json || echo "[]")
          if [[ "$IMAGES" != "[]" ]]; then
            aws ecr batch-delete-image --repository-name ${{ env.ECR_REPO_NAME }} --image-ids "$IMAGES"
            echo "âœ… Images Deleted."
          else
            echo "âœ… Repo is already empty."
          fi

      # ---------------------------------------------------------
      # ğŸ’¥ Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„ØªØ¯Ù…ÙŠØ± Ø¨Ù€ Terraform
      # ---------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init -backend-config="bucket=${{ secrets.BUCKET }}"

      # Ø¨Ù†Ø¹Ù…Ù„ Refresh Ø¹Ø´Ø§Ù† ÙŠÙƒØªØ´Ù Ø¥Ù†Ù†Ø§ Ù…Ø³Ø­Ù†Ø§ Ø§Ù„Ù€ LBs Ù…Ù† ÙˆØ±Ø§Ù‡ ÙˆÙ…ÙŠØ²Ø¹Ù„Ø´
      - name: Terraform Refresh
        run: terraform refresh

      - name: Terraform Destroy
        run: terraform destroy -auto-approve